{{- $architecture := or .architecture "arm64" -}}
{{- $firmware_version := or .firmware_version "master" -}}
{{ $suite :=  or .suite "bionic" }}
{{- $image := or .image "mycroft-mark2-rpi4.img" -}}

architecture: {{ $architecture }}

actions:

    # Mycroft packages
  - action: apt
    description: Mycroft packages
    packages:
      - mycroft-gui
      - qml-module-org-kde-lottie

  - action: download
    description: Download Noto Sans Font
    url: https://noto-website-2.storage.googleapis.com/pkgs/NotoSansDisplay-hinted.zip
    name: noto-sans-display
    filename: NotoSansDisplay-hinted.zip
    unpack: true
    compression: zip

  - action: overlay
    description: Install fonts into filesystem
    origin: noto-sans-display
    source: .
    destination: /usr/share/fonts/truetype/noto

  - action: run
    description: Set font permissions
    chroot: true
    command: chmod +r /usr/share/fonts/truetype/noto/*

  - action: run
    description: Update font cache
    chroot: true
    command: fc-cache -f -v

  - action: apt
    description: Mycroft Mark 2 specific packages
    packages:
      - plasma-nano
      - mycroft-gui-mark-2

  - action: overlay
    description: Mycroft Mark 2 specific overlay
    source: ../overlays/mark2

  - action: run
    description: Create GPIO group to access /dev/gpiomem
    chroot: true
    script: ../scripts/81-access_gpiomem.sh

  - action: overlay
    description: Override default RPi4 firmware config
    source: ../overlays/mark2-config
    destination: /boot/firmware

  - action: run
    description: Add I2S kernel module
    chroot: true
    command: insmod /lib/modules/i2s/i2s_master_loader.ko

  - action: run
    chroot: true
    command: /lib/modules/i2s/setup_bclk

  - action: run
    chroot: true
    command: /lib/modules/i2s/setup_mclk
    